version: 2.1
jobs:
  log-in:
    docker:
      # Secondary container image on common network.
      - image: google/cloud-sdk:slim

    working_directory: ~/tf-jenkins-gke/dev

    steps:
      # command will execute in trusty container
      # and can access mongo on localhost
      - checkout:
          path: ~/tf-jenkins-gke
      - run: gcloud auth activate-service-account cd-jenkins@sandbox-io-289003.iam.gserviceaccount.com --key-file $GCP_KEY --project=sandbox-io-289003
      - run: echo $GCP_KEY
  build:
    docker:
      # Secondary container image on common network.
      - image: hashicorp/terraform:1.1.0

    working_directory: ~/tf-jenkins-gke/dev

    steps:
      # command will execute in trusty container
      # and can access mongo on localhost
      - checkout:
          path: ~/tf-jenkins-gke
      - run: terraform init

workflows:
  my-workflow:
    jobs:
      - log-in:
          context:
            - gcp-key
      - build:
          requires:
            - log-in